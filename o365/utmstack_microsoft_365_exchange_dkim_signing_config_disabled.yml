# Original query
#query = '''
#event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Set-DkimSigningConfig" and o365.audit.Parameters.Enabled:False and event.outcome:success
#'''


# PENDING TO VERIFICATION

- name: Microsoft 365 Exchange DKIM Signing Configuration Disabled
  severity: Medium
  description: 'Identifies when a DomainKeys Identified Mail (DKIM) signing configuration is disabled in Microsoft 365. With DKIM in
    Microsoft 365, messages that are sent from Exchange Online will be cryptographically signed. This will allow the
    receiving email system to validate that the messages were generated by a server that the organization authorized and not
    being spoofed.'
  solution: "When it comes to protecting its users, Microsoft takes the threat of phishing seriously. Spoofing is a common technique that's 
    used by attackers. Spoofed messages appear to originate from someone or somewhere other than the actual source. This technique is often 
    used in phishing campaigns that are designed to obtain user credentials. The anti-spoofing technology in EOP specifically examines forgery of the From header in the message body (used to display the message sender in email clients). When EOP has high confidence that the From header is forged, the message is identified as spoofed.<br>
    <strong> False positive: </strong> Disabling a DKIM configuration may be done by a system or network administrator. 
    Verify that the configuration change was expected. Exceptions can be added to this rule to filter expected behavior."
  category: "Phishing"
  tactic: "Spoofing"
  reference: ["https://docs.microsoft.com/en-us/powershell/module/exchange/set-dkimsigningconfig?view=exchange-ps","https://docs.microsoft.com/en-us/microsoft-365/security/office-365-security/anti-spoofing-protection?view=o365-worldwide"]
  frequency: 30
  cache:
    - allOf:
        - field:  logx.o365.Category
          operator: "=="
          value: 'ThreatManagement'
        - field: logx.o365.Workload
          operator: "=="
          value: 'Exchange'
        - field: logx.o365.Operation
          operator: "=="
          value: 'Set-DkimSigningConfig'
        - field: logx.o365.ResultStatus
          operator: "in"
          value: 'Success,PartiallySucceeded,True'
      minCount: 1
      timeLapse: 30
      save:
        - field: "logx.o365.UserId"
          alias: "SourceUser"
        - field: "logx.o365.ClientIP"
          alias: "SourceIP"
