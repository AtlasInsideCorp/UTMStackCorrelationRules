# Original query
#event.dataset:o365.audit and event.provider:Exchange and event.category:web and event.action:"Disable-SafeAttachmentRule" and event.outcome:success

# PENDING TO VERIFICATION

- name: "Microsoft 365 Exchange Safe Attachment Rule Disabled"
  severity: Medium
  description: "Identifies when a safe attachment rule is disabled in Microsoft 365. Safe attachment rules can extend malware
    protections to include routing all messages and attachments without a known malware signature to a special hypervisor
    environment. An adversary or insider threat may disable a safe attachment rule to exfiltrate data or evade defenses."
  solution: "Defense Evasion consists of techniques that adversaries use to avoid detection throughout their compromise. Techniques used for defense evasion include uninstalling/disabling security software or obfuscating/encrypting data and scripts. Adversaries also leverage and abuse trusted processes to hide and masquerade their malware. Other tacticsâ€™ techniques are cross-listed here when those techniques include the added benefit of subverting defenses.<br>
    <ol>
    <li>Ensure proper process and file permissions are in place to prevent adversaries from disabling or interfering with security/logging services.</li>
    <li>Ensure proper Registry permissions are in place to prevent adversaries from disabling or interfering with security/logging services.</li>
    <li>Ensure proper user permissions are in place to prevent adversaries from disabling or interfering with security/logging services.</li>
    </ol><br>
    <strong> False positive: </strong> A safe attachment rule may be disabled by a system or network administrator. Verify that the configuration change
    was expected. Exceptions can be added to this rule to filter expected behavior."
  category: "Impair Defenses"
  tactic: "Defense Evasion"
  reference: ["https://docs.microsoft.com/en-us/powershell/module/exchange/disable-safeattachmentrule?view=exchange-ps","https://attack.mitre.org/techniques/T1562/","https://attack.mitre.org/tactics/TA0005/"]
  frequency: 30
  cache:
    - allOf:
        - field:  logx.o365.Category
          operator: "=="
          value: 'ThreatManagement'
        - field: logx.o365.Workload
          operator: "=="
          value: 'Exchange'
        - field: logx.o365.Operation
          operator: "=="
          value: 'Disable-SafeAttachmentRule'
        - field: logx.o365.ResultStatus
          operator: "in"
          value: 'Success,PartiallySucceeded,True'
      minCount: 1
      timeLapse: 30
      save:
        - field: "logx.o365.UserId"
          alias: "SourceUser"
        - field: "logx.o365.ClientIP"
          alias: "SourceIP"
