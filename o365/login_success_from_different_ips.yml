#Rule version v1.0.0

- name: "Microsoft 365 Multiple Succesfull Logins detected from different IPs"
  severity: "High"
  description: "Adversaries may obtain and abuse credentials of existing accounts as a means of gaining Initial Access, 
                Persistence, Privilege Escalation, or Defense Evasion. Compromised credentials may be used to bypass access 
                controls placed on various resources on systems within the network and may even be used for persistent access 
                to remote systems and externally available services, such as VPNs, Outlook Web Access, network devices, and remote desktop. 
                Compromised credentials may also grant an adversary increased privilege to specific systems or access to restricted areas of the network. 
                Adversaries may choose not to use malware or tools in conjunction with the legitimate access those credentials provide to make it harder to detect their presence."
  solution: "Ensure that applications do not store sensitive data or credentials insecurely.
      Applications and appliances that utilize default username and password should be changed immediately after the installation, 
      and before deployment to a production environment. When possible, applications that use SSH keys should be updated periodically and properly secured.
      Regularly audit user accounts for activity and deactivate or remove any that are no longer needed.
      Applications may send push notifications to verify a login as a form of multi-factor authentication (MFA). 
      Train users to only accept valid push notifications and to report suspicious push notifications."
  category: "Initial Access"
  tactic: "Valid Accounts"
  reference: 
    - "https://attack.mitre.org/techniques/T1078/"
    - "https://attack.mitre.org/tactics/TA0001/"
  frequency: 60
  cache:
    - allOf:
        - field: "logx.o365.Workload"
          operator: "in"
          value: "Exchange,AzureActiveDirectory"
        - field: "logx.o365.Operation"
          operator: "in"
          value: "UserLoggedIn"
        - field: "logx.o365.ResultStatus"
          operator: "in"
          value: "Success,PartiallySucceeded,True"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.o365.UserId"
          alias: "USER_NAME"
        - field: "logx.o365.ClientIP"
          alias: "CLIENT_IP"
    - allOf:
        - field: "logx.o365.Workload"
          operator: "in"
          value: "Exchange,AzureActiveDirectory"
        - field: "logx.o365.Operation"
          operator: "in"
          value: "UserLoggedIn"
        - field: "logx.o365.ResultStatus"
          operator: "in"
          value: "Success,PartiallySucceeded,True"
        - field: "logx.o365.UserId"
          operator: "=="
          value: "{{.USER_NAME}}"
        - field: "logx.o365.ClientIP"
          operator: "!="
          alias: "{{.CLIENT_IP}}"
      minCount: 1
      timeLapse: 3600
      save:
        - field: "logx.o365.UserId"
          alias: "SourceUser"
        - field: "logx.o365.ClientIP"
          alias: "SourceIP"
