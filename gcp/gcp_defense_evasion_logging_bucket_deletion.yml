# Original query
#event.dataset:(googlecloud.audit or gcp.audit) and event.action:google.logging.v*.ConfigServiceV*.DeleteBucket and event.outcome:success

#Based on https://cloud.google.com/security-command-center/docs/how-to-use-event-threat-detection (may, 2022)
#https://cloud.google.com/security-command-center/docs/concepts-event-threat-detection-overview (may, 2022)
#https://cloud.google.com/logging/docs/audit/gsuite-login-samples (may, 2022)
#https://github.com/elastic/detection-rules/blob/main/rules/integrations/gcp/defense_evasion_gcp_logging_bucket_deletion.toml (may, 2022)
#Rule version v1.0.0

- name: "GCP probable Defense Evasion, Logging Bucket Deletion"
  severity: "Medium"
  description: "Defense Evasion consists of techniques that adversaries use to avoid detection throughout their compromise. 
                Techniques used for defense evasion include uninstalling/disabling security software or 
                obfuscating/encrypting data and scripts. Adversaries also leverage and abuse trusted processes 
                to hide and masquerade their malware. Other tactics are cross-listed here when those techniques 
                include the added benefit of subverting defenses. <br> 
                Identifies a Logging bucket deletion in Google Cloud Platform (GCP). Log buckets are containers that store and organize
                log data. A deleted bucket stays in a pending state for 7 days, and Logging continues to route logs to the bucket during
                that time. To stop routing logs to a deleted bucket, the log sinks can be deleted that have the bucket as a destination,
                or the filter for the sinks can be modified to stop routing logs to the deleted bucket. An adversary may delete a log
                bucket to evade detection.  "
  solution: "<ol>
    <li>Verify whether the user email, resource name, and/or hostname should be making changes in your environment.</li>
    <li>See the logs attached to this alert for more information.</li>
    </ol><br>
    <strong>Potential false positive: </strong> Logging bucket deletions may be done by a system or network administrator. Logging bucket deletions by unfamiliar users
    or hosts should be investigated."
  category: "Defense Evasion"
  tactic: "Impair Defenses"
  reference: 
    - "https://cloud.google.com/logging/docs/buckets"
    - "https://attack.mitre.org/techniques/T1562/"
    - "https://attack.mitre.org/tactics/TA0005/"
  frequency: 60
  cache:
    - allOf:
        - field: "logx.google.protoPayload.methodName"
          operator: "regexp"
          value: "((.+)\\.bucket(s)?\\.delete|(.+)?v(\\w+)\\.ConfigServiceV(\\w+)\\.DeleteBucket)"
        - field: "logx.google.protoPayload.metadata.event.*.success"
          operator: "=="
          value: "true"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.google.protoPayload.authenticationInfo.principalEmail"
          alias: "SourceUser"
        - field: "logx.google.src_ip"
          alias: "SourceIp"
