# Based in Sophos Firewall 17.5+
# Rule version v1.0.1

- name: "Probable defense evasion, an application with high risk allowed by firewall"
  severity: Medium
  description: "The Sophos firewall device has detected an application with elevated risk that was not denied or dropped by firewall.
                Please see the logs attached to this alert for additional details."
  solution: "<ol>
    <li>See the logs attached to identify the origin of the alert</li>
    <li>Check the device configuration to detect why this application was not denied or dropped</li>
    </ol>"
  category: "Defense Evasion"
  tactic: "Impair Defenses: Disable or Modify Tools"
  reference: 
    - "https://attack.mitre.org/tactics/TA0005/"
    - "https://attack.mitre.org/techniques/T1562/001/"
  frequency: 60
  cache:
    - allOf:
        - field: "logx.sophos.application_risk"
          operator: ">="
          value: 4
        - field: "logx.sophos.log_subtype"
          operator: "not in"
          value: "Deny,deny,Drop,drop"
      oneOf:
        - field: "logx.sophos.application_name"
          operator: "not in"
          value: "Torrent P2P Clients,Torrent Clients P2P"
        - field: "logx.sophos.application"
          operator: "not in"
          value: "Torrent P2P Clients,Torrent Clients P2P"
        - field: "logx.sophos.application"
          operator: "not exist"
          value: 
        - field: "logx.sophos.application_name"
          operator: "not exist"
          value: 
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.sophos.proto"
          alias: "Protocol"
        - field: "logx.sophos.user_name"
          alias: "SourceUser"
        - field: "logx.sophos.src_ip"
          alias: "SourceIP"
        - field: "logx.sophos.src_port"
          alias: "SourcePort"
        - field: "logx.sophos.dest_ip"
          alias: "DestinationIP"
        - field: "logx.sophos.dest_port"
          alias: "DestinationPort"
