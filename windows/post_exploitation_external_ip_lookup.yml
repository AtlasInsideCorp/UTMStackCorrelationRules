# Rule version v1.0.1

- name: "Windows: External IP Lookup from Non-Browser Process"
  severity: "low"
  description: "Identifies domains commonly used by adversaries for post-exploitation IP lookups. It is common for adversaries to
                test for Internet access and acquire their external IP address after they have gained access to a system. Among others,
                this has been observed in campaigns leveraging the information stealer, Trickbot."
  solution: "Isolate the involved hosts to prevent further post-compromise behavior.
      Use the data collected through the analysis to investigate other machines affected in the environment.
      Investigate credential exposure on systems compromised or used by the attacker to ensure all compromised accounts are
      identified. Reset passwords for these accounts and other potentially compromised credentials, such as email, business systems, and web services.
      Run a full antimalware scan. This may reveal additional artifacts left in the system, persistence mechanisms, and malware components.
      Determine the initial vector abused by the attacker and take action to prevent reinfection via the same vector."
  category: "Discovery"
  tactic: "System Network Configuration Discovery"
  reference:
    - "https://attack.mitre.org/tactics/TA0007/"
    - "https://attack.mitre.org/techniques/T1016/"
  frequency: 60
  cache: 
    - allOf:
        - field: "logx.wineventlog.network.protocol"
          operator: "=="
          value: "dns"
        - field: "logx.wineventlog.user.id"
          operator: "not in"
          value: "S-1-5-19,S-1-5-20"
        - field: "logx.wineventlog.event.action"
          operator: "=="
          value: "lookup_requested"
        - field: "logx.wineventlog.dns.question.name"
          operator: "regexp"
          value: "(api.ipify.org|freegeoip.app|checkip.amazonaws.com|checkip.dyndns.org|freegeoip.app|icanhazip.com|ifconfig.|ipecho.net|ipgeoapi.com|ipinfo.io|ip.anysrc.net|myexternalip.com|myipaddress.com|showipaddress.com|whatismyipaddress.com|wtfismyip.com|ipapi.co|ip-lookup.net|ipstack.com)"
        - field: "logx.wineventlog.process.executable"
          operator: "not regexp"
          value: "(:\\\\Program Files\\\\(.+).exe|:\\\\Program Files (x86)\\\\(.+).exe|:\\\\Windows\\\\System32\\\\WWAHost.exe|:\\\\Windows\\\\System32\\\\smartscreen.exe|:\\\\Windows\\\\System32\\\\MicrosoftEdgeCP.exe|:\\\\ProgramData\\\\Microsoft\\\\Windows Defender\\\\Platform\\\\(.+)\\\\MsMpEng.exe|:\\\\Users\\\\(.+)\\\\AppData\\\\Local\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe|:\\\\Users\\\\(.+)\\\\AppData\\\\Local\\\\Programs\\\\Fiddler\\\\Fiddler.exe|:\\\\Users\\\\(.+)\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe|:\\\\Users\\\\(.+)\\\\AppData\\\\Local\\\\Microsoft\\\\OneDrive\\\\OneDrive.exe)"
      minCount: 1
      timeLapse: 60
      save:
        - field: "logx.wineventlog.event_data.SubjectUserName"
          alias: "SourceUser"
        - field: "logx.wineventlog.host.name"
          alias: "SourceHost"
        - field: "logx.wineventlog.event_data.SourceAddress"
          alias: "SourceIP"
        - field: "logx.wineventlog.event_data.SourcePort"
          alias: "SourcePort"
        - field: "logx.wineventlog.event_data.TargetUserName"
          alias: "DestinationUser"
        - field: "logx.wineventlog.event_data.DestAddress"
          alias: "DestinationIP"
        - field: "logx.wineventlog.event_data.DestPort"
          alias: "DestinationPort"
