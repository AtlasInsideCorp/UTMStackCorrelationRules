- name: "The ACL was set on accounts which are members of administrators groups"
  severity: "Medium"
  description: "Every hour, the domain controller that holds the primary domain controller (PDC) Flexible Single Master Operation (FSMO) role compares the ACL on all security principal accounts (users, groups, and machine accounts) present for its domain in Active Directory and that are in administrative or security-sensitive groups and which have AdminCount attribute = 1 against the ACL on the AdminSDHolder object. If the ACL on the principal account differs from the ACL on the AdminSDHolder object, then the ACL on the principal account is reset to match the ACL on the AdminSDHolder object and this event is generated. Monitor for this event and investigate why the objectï¿½s ACL was changed"
  solution: " Audit domain account permission levels routinely to look for situations that could allow an adversary to gain wide access by obtaining credential of a provileged account. Do not put user or admin domain accounts in the local administratot groups across system unless they are tightly controlled and use of accounts is segmented, as this is often equivalent to having a local administrator account with the same password on all systems."
  category: "Valid Accounts: Domain Accounts"
  tactic: "Defence Evation"
  reference: 
    - "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4780"
  frequency: 60
  cache:
    - allOf:
        - field: "logx.wineventlog.event_id"  
          operator: "=="
          value: 4780
      timeLapse: 60
      minCount: 1
      save:
        - field: "logx.wineventlog.event_data.SubjectUserName"
          alias: "SourceUser"
        - field: "logx.wineventlog.event_data.TargetUserName"
          alias: "DestinationUser"
        - field: "logx.wineventlog.host.name"
          alias: "SourceHost"