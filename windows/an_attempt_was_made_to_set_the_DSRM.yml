#Based in https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor
#And https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers
#Rule version v1.0.1

- name: "An attempt was made to set the Directory Services Restore Mode"
  severity: "High"
  description: "This event generates on every attempt made to set the Directory Services Restore Mode.
                Is a function on Active Directory Domain Controllers to take the server offline for emergency maintenance, 
                particularly restoring backups of AD objects. It is accessed on Windows Server via the advanced startup menu, 
                similarly to safe mode."
  solution: "Check the logs attached to this alert and investigate is authorized operation or is part of an attack.
             Anyone with the password who has access to the domain controller can reboot the machine, copy and modify 
             the Active Directory database, and reboot the server without leaving any trace of the activity"
  category: "Collection"
  tactic: "Data from Local System"
  reference: 
    - "https://attack.mitre.org/tactics/TA0009/"
    - "https://attack.mitre.org/techniques/T1005"
    - "https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/appendix-l--events-to-monitor"
    - "https://docs.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4794"
  frequency: 5
  cache:
    - allOf:
        - field: "logx.wineventlog.event_id"
          operator: "=="
          value: "4794"
      timeLapse: 5
      minCount: 1
      save:
        - field: "logx.wineventlog.event_data.SubjectUserName"
          alias: "SourceUser"
        - field: "logx.wineventlog.host.name"
          alias: "SourceHost"
